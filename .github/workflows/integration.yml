name: Integration Tests

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  integration:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      integration-tests-sha: ${{ github.sha }}
      user-service-sha: ${{ steps.checkout-user.outputs.commit }}
      video-service-sha: ${{ steps.checkout-video.outputs.commit }}
      location-service-sha: ${{ steps.checkout-location.outputs.commit }}
      moderation-service-sha: ${{ steps.checkout-moderation.outputs.commit }}
      search-service-sha: ${{ steps.checkout-search.outputs.commit }}
      api-gateway-sha: ${{ steps.checkout-gateway.outputs.commit }}
      web-app-sha: ${{ steps.checkout-webapp.outputs.commit }}

    steps:
      - name: Checkout integration tests
        uses: actions/checkout@v4

      - name: Checkout AccountabilityAtlas (docker-compose)
        uses: actions/checkout@v4
        with:
          repository: kelleyglenn/AccountabilityAtlas
          path: infra

      - name: Checkout user-service
        id: checkout-user
        uses: actions/checkout@v4
        with:
          repository: kelleyglenn/AcctAtlas-user-service
          path: infra/AcctAtlas-user-service

      - name: Checkout video-service
        id: checkout-video
        uses: actions/checkout@v4
        with:
          repository: kelleyglenn/AcctAtlas-video-service
          path: infra/AcctAtlas-video-service

      - name: Checkout location-service
        id: checkout-location
        uses: actions/checkout@v4
        with:
          repository: kelleyglenn/AcctAtlas-location-service
          path: infra/AcctAtlas-location-service

      - name: Checkout moderation-service
        id: checkout-moderation
        uses: actions/checkout@v4
        with:
          repository: kelleyglenn/AcctAtlas-moderation-service
          path: infra/AcctAtlas-moderation-service

      - name: Checkout search-service
        id: checkout-search
        uses: actions/checkout@v4
        with:
          repository: kelleyglenn/AcctAtlas-search-service
          path: infra/AcctAtlas-search-service

      - name: Checkout api-gateway
        id: checkout-gateway
        uses: actions/checkout@v4
        with:
          repository: kelleyglenn/AcctAtlas-api-gateway
          path: infra/AcctAtlas-api-gateway

      - name: Checkout web-app
        id: checkout-webapp
        uses: actions/checkout@v4
        with:
          repository: kelleyglenn/AcctAtlas-web-app
          path: infra/AcctAtlas-web-app

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build user-service image
        working-directory: infra/AcctAtlas-user-service
        run: ./gradlew jibDockerBuild

      - name: Build video-service image
        working-directory: infra/AcctAtlas-video-service
        run: ./gradlew jibDockerBuild

      - name: Build location-service image
        working-directory: infra/AcctAtlas-location-service
        run: ./gradlew jibDockerBuild

      - name: Build moderation-service image
        working-directory: infra/AcctAtlas-moderation-service
        run: ./gradlew jibDockerBuild

      - name: Build search-service image
        working-directory: infra/AcctAtlas-search-service
        run: ./gradlew jibDockerBuild

      - name: Build api-gateway image
        working-directory: infra/AcctAtlas-api-gateway
        run: ./gradlew jibDockerBuild

      - name: Start services
        working-directory: infra
        run: docker compose --profile backend --profile frontend up -d --wait
        env:
          NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN: ${{ secrets.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run API tests
        timeout-minutes: 10
        run: npm run test:api
        env:
          API_URL: http://localhost:8080/api/v1
          SERVICE_HOST: localhost

      - name: Upload API test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-playwright-report
          path: api/playwright-report/
          retention-days: 14

      - name: Upload API test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-results
          path: api/test-results/
          retention-days: 14

      - name: Run E2E tests
        timeout-minutes: 10
        run: xvfb-run npm run test:e2e
        env:
          BASE_URL: http://localhost:3000
          API_URL: http://localhost:8080/api/v1

      - name: Upload E2E test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-playwright-report
          path: e2e/playwright-report/
          retention-days: 14

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: e2e/test-results/
          retention-days: 14

      - name: Stop services
        if: always()
        working-directory: infra
        run: docker compose --profile backend --profile frontend down

  tag-on-success:
    runs-on: ubuntu-latest
    needs: [integration]
    if: ${{ success() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch') }}

    steps:
      - name: Log tested commits
        run: |
          echo "## Tested Commits" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Repo | Commit |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| integration-tests | [${INTEGRATION_SHA:0:7}](https://github.com/kelleyglenn/AcctAtlas-integration-tests/commit/$INTEGRATION_SHA) |" >> $GITHUB_STEP_SUMMARY
          echo "| user-service | [${USER_SHA:0:7}](https://github.com/kelleyglenn/AcctAtlas-user-service/commit/$USER_SHA) |" >> $GITHUB_STEP_SUMMARY
          echo "| video-service | [${VIDEO_SHA:0:7}](https://github.com/kelleyglenn/AcctAtlas-video-service/commit/$VIDEO_SHA) |" >> $GITHUB_STEP_SUMMARY
          echo "| location-service | [${LOCATION_SHA:0:7}](https://github.com/kelleyglenn/AcctAtlas-location-service/commit/$LOCATION_SHA) |" >> $GITHUB_STEP_SUMMARY
          echo "| moderation-service | [${MODERATION_SHA:0:7}](https://github.com/kelleyglenn/AcctAtlas-moderation-service/commit/$MODERATION_SHA) |" >> $GITHUB_STEP_SUMMARY
          echo "| search-service | [${SEARCH_SHA:0:7}](https://github.com/kelleyglenn/AcctAtlas-search-service/commit/$SEARCH_SHA) |" >> $GITHUB_STEP_SUMMARY
          echo "| api-gateway | [${GATEWAY_SHA:0:7}](https://github.com/kelleyglenn/AcctAtlas-api-gateway/commit/$GATEWAY_SHA) |" >> $GITHUB_STEP_SUMMARY
          echo "| web-app | [${WEBAPP_SHA:0:7}](https://github.com/kelleyglenn/AcctAtlas-web-app/commit/$WEBAPP_SHA) |" >> $GITHUB_STEP_SUMMARY
        env:
          INTEGRATION_SHA: ${{ needs.integration.outputs.integration-tests-sha }}
          USER_SHA: ${{ needs.integration.outputs.user-service-sha }}
          VIDEO_SHA: ${{ needs.integration.outputs.video-service-sha }}
          LOCATION_SHA: ${{ needs.integration.outputs.location-service-sha }}
          MODERATION_SHA: ${{ needs.integration.outputs.moderation-service-sha }}
          SEARCH_SHA: ${{ needs.integration.outputs.search-service-sha }}
          GATEWAY_SHA: ${{ needs.integration.outputs.api-gateway-sha }}
          WEBAPP_SHA: ${{ needs.integration.outputs.web-app-sha }}

      - name: Create tags
        env:
          GH_TOKEN: ${{ secrets.INTEGRATION_TEST_PAT }}
          INTEGRATION_SHA: ${{ needs.integration.outputs.integration-tests-sha }}
          USER_SHA: ${{ needs.integration.outputs.user-service-sha }}
          VIDEO_SHA: ${{ needs.integration.outputs.video-service-sha }}
          LOCATION_SHA: ${{ needs.integration.outputs.location-service-sha }}
          MODERATION_SHA: ${{ needs.integration.outputs.moderation-service-sha }}
          SEARCH_SHA: ${{ needs.integration.outputs.search-service-sha }}
          GATEWAY_SHA: ${{ needs.integration.outputs.api-gateway-sha }}
          WEBAPP_SHA: ${{ needs.integration.outputs.web-app-sha }}
        run: |
          TAG_NAME="integration-tested-$(date +%Y%m%d)-${{ github.run_id }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          echo "Creating tag: $TAG_NAME"
          echo "Run URL: $RUN_URL"

          tag_repo() {
            local repo=$1
            local sha=$2
            local retries=3

            echo "Tagging $repo at $sha..."

            for ((i=1; i<=retries; i++)); do
              TAG_SHA=$(gh api "repos/kelleyglenn/${repo}/git/tags" \
                -f tag="$TAG_NAME" \
                -f message="Integration tests passed. Run: $RUN_URL" \
                -f object="$sha" \
                -f type="commit" \
                --jq '.sha' 2>/dev/null) || true

              if [ -n "$TAG_SHA" ]; then
                if gh api "repos/kelleyglenn/${repo}/git/refs" \
                  -f ref="refs/tags/$TAG_NAME" \
                  -f sha="$TAG_SHA" >/dev/null 2>&1; then
                  echo "Successfully tagged $repo"
                  return 0
                fi
              fi

              echo "Attempt $i/$retries failed for $repo, retrying in 2s..."
              sleep 2
            done

            echo "::warning::Failed to tag $repo after $retries attempts"
            return 0
          }

          tag_repo "AcctAtlas-integration-tests" "$INTEGRATION_SHA"
          tag_repo "AcctAtlas-user-service" "$USER_SHA"
          tag_repo "AcctAtlas-video-service" "$VIDEO_SHA"
          tag_repo "AcctAtlas-location-service" "$LOCATION_SHA"
          tag_repo "AcctAtlas-moderation-service" "$MODERATION_SHA"
          tag_repo "AcctAtlas-search-service" "$SEARCH_SHA"
          tag_repo "AcctAtlas-api-gateway" "$GATEWAY_SHA"
          tag_repo "AcctAtlas-web-app" "$WEBAPP_SHA"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Tag Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`$TAG_NAME\`" >> $GITHUB_STEP_SUMMARY